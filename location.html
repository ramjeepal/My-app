<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Delivery Distance Test</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <style>
    body, html {
      margin: 0;
      height: 100%;
      font-family: sans-serif;
      overflow: hidden;
    }
    #map {
      height: 75%;
      transition: filter 0.5s;
    }
    #result {
      height: 10%;
      background: rgba(255,255,255,0.95);
      padding: 10px;
      font-size: 16px;
      text-align: center;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #actions {
      height: 15%;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    button {
      padding: 10px 20px;
      font-size: 16px;
      border: none;
      border-radius: 6px;
      background: #007bff;
      color: white;
      cursor: pointer;
    }
    button:disabled {
      background: gray;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="result">üìç ‡§Ü‡§™‡§ï‡•Ä ‡§≤‡•ã‡§ï‡•á‡§∂‡§® ‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡•Ä ‡§π‡•à...</div>
  <div id="actions">
    <button id="saveBtn">üè† ‡§π‡•ã‡§Æ ‡§≤‡•ã‡§ï‡•á‡§∂‡§® ‡§∏‡•á‡§µ ‡§ï‡§∞‡•á‡§Ç</button>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    // ‡§¶‡•Å‡§ï‡§æ‡§® ‡§ï‡•Ä ‡§≤‡•ã‡§ï‡•á‡§∂‡§® (Ganesh Nagar, Bhuj)
    const shopLat = 23.23823;
    const shopLng = 69.64792;
    const apiKey = "eyJvcmciOiI1YjNjZTM1OTc4NTExMTAwMDFjZjYyNDgiLCJpZCI6IjYwYTBhNTY1MGIxZTQ4OTNiNjk4YWY3MmEzNjQxZTRmIiwiaCI6Im11cm11cjY0In0=";

    const map = L.map("map").setView([23.23823, 69.64792], 13);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: "¬© OpenStreetMap"
    }).addTo(map);

    const resultBox = document.getElementById("result");
    const saveBtn = document.getElementById("saveBtn");

    let userLat, userLng;
    let marker;

    // localStorage ‡§∏‡•á ‡§™‡§ø‡§õ‡§≤‡§æ ‡§∞‡§ø‡§ú‡§º‡§≤‡•ç‡§ü ‡§ö‡•á‡§ï ‡§ï‡§∞‡•ã
    const savedData = JSON.parse(localStorage.getItem("homeLocationData"));
    if (savedData) {
      const savedDate = new Date(savedData.date);
      const now = new Date();
      const diffDays = Math.floor((now - savedDate) / (1000*60*60*24));

      // marker ‡§π‡§Æ‡•á‡§∂‡§æ saved location ‡§™‡§∞ ‡§¶‡§ø‡§ñ‡§æ‡§ì
      marker = L.marker([savedData.lat, savedData.lng])
        .addTo(map)
        .bindPopup("‡§Ü‡§™‡§ï‡•Ä ‡§∏‡•á‡§µ ‡§ï‡•Ä ‡§ó‡§à ‡§≤‡•ã‡§ï‡•á‡§∂‡§®")
        .openPopup();

      map.setView([savedData.lat, savedData.lng], 14);
      resultBox.innerText = savedData.message + " (‡§∏‡•á‡§µ‡•ç‡§°)";

      if (diffDays < 30) {
        saveBtn.disabled = true; // 30 ‡§¶‡§ø‡§® ‡§§‡§ï ‡§®‡§à ‡§≤‡•ã‡§ï‡•á‡§∂‡§® ‡§∏‡•á‡§µ ‡§®‡§π‡•Ä‡§Ç ‡§ï‡§∞ ‡§∏‡§ï‡§§‡•á
      }
    } else {
      // ‡§Ö‡§ó‡§∞ ‡§ï‡•ã‡§à ‡§∏‡•á‡§µ ‡§°‡•á‡§ü‡§æ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à ‡§§‡•ã current location detect ‡§ï‡§∞‡•ã
      if ("geolocation" in navigator) {
        navigator.geolocation.getCurrentPosition(pos => {
          userLat = pos.coords.latitude;
          userLng = pos.coords.longitude;

          marker = L.marker([userLat, userLng])
            .addTo(map)
            .bindPopup("‡§Ü‡§™‡§ï‡•Ä ‡§µ‡§∞‡•ç‡§§‡§Æ‡§æ‡§® ‡§≤‡•ã‡§ï‡•á‡§∂‡§®")
            .openPopup();

          map.setView([userLat, userLng], 14);
          resultBox.innerText = "‚úÖ ‡§≤‡•ã‡§ï‡•á‡§∂‡§® ‡§Æ‡§ø‡§≤‡•Ä, ‡§Ö‡§¨ ‡§π‡•ã‡§Æ ‡§≤‡•ã‡§ï‡•á‡§∂‡§® ‡§∏‡•á‡§µ ‡§ï‡§∞‡•á‡§Ç";
        });
      } else {
        resultBox.innerText = "‚ùå ‡§≤‡•ã‡§ï‡•á‡§∂‡§® ‡§∏‡§™‡•ã‡§∞‡•ç‡§ü ‡§®‡§π‡•Ä‡§Ç ‡§ï‡§∞‡§§‡§æ";
        saveBtn.disabled = true;
      }
    }

    // ‡§∏‡•á‡§µ ‡§¨‡§ü‡§® ‡§ï‡•ç‡§≤‡§ø‡§ï ‚Üí ‡§¶‡•Ç‡§∞‡•Ä ‡§®‡§ø‡§ï‡§æ‡§≤‡•ã ‡§î‡§∞ ‡§∏‡•á‡§µ ‡§ï‡§∞‡•ã
    saveBtn.addEventListener("click", async () => {
      if (!userLat || !userLng) {
        alert("‡§≤‡•ã‡§ï‡•á‡§∂‡§® ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡•Ä!");
        return;
      }

      // ORS API ‡§ï‡•â‡§≤
      const url = "https://api.openrouteservice.org/v2/directions/driving-car/json";
      const body = {
        coordinates: [
          [shopLng, shopLat],
          [userLng, userLat]
        ]
      };

      const res = await fetch(url, {
        method: "POST",
        headers: {
          "Authorization": apiKey,
          "Content-Type": "application/json"
        },
        body: JSON.stringify(body)
      });

      const data = await res.json();

      if (data.routes && data.routes[0].summary) {
        const distKm = data.routes[0].summary.distance / 1000;
        let msg = "";

        if (distKm <= 5) {
          msg = "‚úÖ ‡§Ü‡§™ 0 ‡§∏‡•á 5 ‡§ï‡§ø‡§≤‡•ã‡§Æ‡•Ä‡§ü‡§∞ (Red Zone) ‡§Æ‡•á‡§Ç ‡§Ü‡§§‡•á ‡§π‡•à‡§Ç";
        } else if (distKm <= 10) {
          msg = "üü° ‡§Ü‡§™ 5 ‡§∏‡•á 10 ‡§ï‡§ø‡§≤‡•ã‡§Æ‡•Ä‡§ü‡§∞ (Yellow Zone) ‡§Æ‡•á‡§Ç ‡§Ü‡§§‡•á ‡§π‡•à‡§Ç";
        } else if (distKm <= 15) {
          msg = "üîµ ‡§Ü‡§™ 10 ‡§∏‡•á 15 ‡§ï‡§ø‡§≤‡•ã‡§Æ‡•Ä‡§ü‡§∞ (Blue Zone) ‡§Æ‡•á‡§Ç ‡§Ü‡§§‡•á ‡§π‡•à‡§Ç";
        } else {
          msg = "‚ùå ‡§Ü‡§™ ‡§π‡§Æ‡§æ‡§∞‡•Ä ‡§∏‡•á‡§µ‡§æ ‡§ï‡•ç‡§∑‡•á‡§§‡•ç‡§∞ ‡§∏‡•á ‡§¨‡§æ‡§π‡§∞ ‡§π‡•à‡§Ç";
        }

        resultBox.innerText = msg;

        // localStorage ‡§Æ‡•á‡§Ç ‡§∏‡•á‡§µ ‡§ï‡§∞‡•ã
        const saveData = {
          message: msg,
          lat: userLat,
          lng: userLng,
          date: new Date()
        };
        localStorage.setItem("homeLocationData", JSON.stringify(saveData));

        // marker update saved location ‡§™‡§∞
        if (marker) map.removeLayer(marker);
        marker = L.marker([userLat, userLng])
          .addTo(map)
          .bindPopup("‡§Ü‡§™‡§ï‡•Ä ‡§∏‡•á‡§µ ‡§ï‡•Ä ‡§ó‡§à ‡§≤‡•ã‡§ï‡•á‡§∂‡§®")
          .openPopup();

        map.setView([userLat, userLng], 14);
        saveBtn.disabled = true;
      } else {
        resultBox.innerText = "‚ùå ‡§¶‡•Ç‡§∞‡•Ä ‡§®‡§ø‡§ï‡§æ‡§≤‡§®‡•á ‡§Æ‡•á‡§Ç ‡§¶‡§ø‡§ï‡•ç‡§ï‡§§ ‡§Ü‡§à";
      }
    });
  </script>
</body>
</html>