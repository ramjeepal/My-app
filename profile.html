<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>Profile — Live Location & Road Distance</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<style>
  body { font-family: Arial, sans-serif; background: linear-gradient(135deg,#f093fb,#f5576c); margin:0; padding:0; }
  .container { max-width:420px; margin:18px auto; background:#fff; padding:14px; border-radius:10px; box-shadow:0 4px 18px rgba(0,0,0,0.15); }
  h2 { text-align:center; color:#f5576c; margin:6px 0 12px; }
  label { font-weight:700; margin-top:8px; display:block; }
  input, textarea { width:100%; padding:8px; margin-top:6px; border-radius:6px; border:1px solid #ddd; }
  button { width:100%; padding:10px; border-radius:8px; border:none; margin-top:10px; font-size:16px; cursor:pointer; }
  .saveBtn { background:#28a745; color:#fff; }
  .locBtn { background:#007bff; color:#fff; }
  .backBtn { background:#ff5722; color:#fff; }
  .info { background:#fafafa; border-radius:8px; padding:8px; margin-top:10px; font-size:14px; }
</style>
</head>
<body>

<div class="container">
  <h2>My Profile</h2>

  <label>Email</label>
  <input type="email" id="email" readonly />

  <label>Name</label>
  <input id="name" placeholder="Enter your name" />

  <label>Primary Phone</label>
  <input id="phone1" placeholder="Enter primary phone" />

  <label>Alternate Phone</label>
  <input id="phone2" placeholder="Enter alternate phone" />

  <label>Address</label>
  <textarea id="address" rows="3" placeholder="Enter your address"></textarea>

  <label>Pin Code</label>
  <input id="pincode" placeholder="Enter 6 digit pin code" />

  <button class="saveBtn" onclick="saveProfile()">Save Profile</button>

  <div class="info" id="liveInfo">
    <div><strong>Live distance:</strong> <span id="liveDistance">—</span></div>
    <div><strong>Zone:</strong> <span id="liveZone">—</span></div>
  </div>

  <!-- Buttons to open new pages -->
  <button class="locBtn" onclick="window.location.href='liveLocation.html'">Show Live Location</button>
  <button class="locBtn" onclick="window.location.href='location.html'">Set / Update Home Location</button>

  <button class="backBtn" onclick="window.location.href='customer.html'">⬅ Back to Home</button>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
  import { getDatabase, ref, update, get } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-database.js";

  // --- FIREBASE CONFIG ---
  const firebaseConfig = {
    apiKey: "AIzaSyAsEVwwD0e26aJtcy0wLp-vW64QKeokTek",
    authDomain: "food-app-8cb8b.firebaseapp.com",
    databaseURL: "https://food-app-8cb8b-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "food-app-8cb8b",
    storageBucket: "food-app-8cb8b.firebasestorage.app",
    messagingSenderId: "473386805089",
    appId: "1:473386805089:web:0100db7ff60e95f4598720",
    measurementId: "G-E42G8RRW9Y"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getDatabase(app);

  let currentUser = null;

  // --- AUTH CHECK ---
  onAuthStateChanged(auth, (user) => {
    if (user) {
      currentUser = user;
      document.getElementById("email").value = user.email;
      loadProfile();
    } else {
      alert("Please login first!");
      window.location.href = "index.html";
    }
  });

  // --- Load Profile ---
  function loadProfile() {
    get(ref(db, "users/" + currentUser.uid + "/profile")).then((snap) => {
      if (snap.exists()) {
        const data = snap.val();
        if (data.name) document.getElementById("name").value = data.name;
        if (data.phone1) document.getElementById("phone1").value = data.phone1;
        if (data.phone2) document.getElementById("phone2").value = data.phone2;
        if (data.address) document.getElementById("address").value = data.address;
        if (data.pincode) document.getElementById("pincode").value = data.pincode;
      }
    }).catch(e => console.error(e));
  }

  // --- Save Profile with validation ---
  function saveProfile() {
    if (!currentUser) return;

    const name = document.getElementById("name").value.trim();
    const phone1 = document.getElementById("phone1").value.trim();
    const phone2 = document.getElementById("phone2").value.trim();
    const address = document.getElementById("address").value.trim();
    const pincode = document.getElementById("pincode").value.trim();

    // --- Required fields check ---
    if (!name || !phone1 || !address || !pincode) {
      alert("कृपया नाम, प्राइमरी फोन, एड्रेस और पिन कोड ज़रूरी भरें!");
      return;
    }

    // --- Format validation ---
    if (!/^[789]\d{9}$/.test(phone1)) {
      alert("Primary phone must be 10 digits and start with 7/8/9!");
      return;
    }
    if (phone2 && !/^[789]\d{9}$/.test(phone2)) {
      alert("Alternate phone must be 10 digits and start with 7/8/9!");
      return;
    }
    if (!/^\d{6}$/.test(pincode)) {
      alert("Pincode must be exactly 6 digits!");
      return;
    }

    // --- Save to Firebase ---
    update(ref(db, "users/" + currentUser.uid + "/profile"), {
      name, phone1, phone2, address, pincode, email: currentUser.email
    })
      .then(() => alert("Profile saved successfully!"))
      .catch(e => {
        console.error(e);
        alert("Error saving profile!");
      });
  }

  // Make saveProfile global
  window.saveProfile = saveProfile;
</script>
</body>
</html>